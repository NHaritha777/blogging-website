<?php
session_start();
include 'config.php';
if (!isset($_SESSION['user_id'])) {
    header("Location: /frontend/index.html");
    exit();
}
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Community - Chat & Posts</title>
  <style>
    body {
      margin:0;
      min-height:100vh;
      background: url('/frontend/bg2.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
    }
    body::before{ content:""; position:fixed; inset:0; background: rgba(0,0,0,0.45); z-index:-1; }
    .wrap{ max-width:900px; margin:40px auto; background: rgba(255,255,255,0.95); padding:20px; border-radius:12px;}
    header { display:flex; justify-content:space-between; align-items:center; }
    .user { font-weight:700; color:#222; }
    .actions { display:flex; gap:8px; }
    button{ padding:8px 12px; border:none; border-radius:8px; cursor:pointer; background:#4a90e2; color:#fff; }
    .post-form textarea{ width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; resize:none; }
    .posts { margin-top:18px; }
    .post { padding:12px; border-bottom:1px solid #e0e0e0; }
    .meta { font-size:13px; color:#666; display:flex; justify-content:space-between; align-items:center; }
    .post .controls { margin-top:8px; display:flex; gap:8px; }
    .comments { margin-top:10px; padding-left:10px; }
    .comment-form{ display:flex; gap:8px; margin-top:8px; }
    .small-btn { padding:6px 10px; border-radius:6px; background:#eee; color:#333; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="user">Logged in: <?php echo htmlspecialchars($_SESSION['username']); ?></div>
      </div>
      <div class="actions">
        <a href="/logout.php"><button>Logout</button></a>
      </div>
    </header>

    <section class="post-form">
      <h3>Post something to the community</h3>
      <textarea id="postContent" rows="3" placeholder="Share an update..."></textarea>
      <div style="margin-top:8px;">
        <button id="postBtn">Post</button>
      </div>
    </section>

    <section class="posts" id="postsContainer">
      <h3>Recent posts</h3>
      <div id="posts"></div>
    </section>
  </div>

<script>
async function fetchPosts(){
  const res = await fetch('/fetch_posts.php', { credentials: 'same-origin' });
  const json = await res.json();
  if(!json.success) return;
  const container = document.getElementById('posts');
  container.innerHTML = '';
  json.posts.forEach(p => {
    const el = document.createElement('div');
    el.className = 'post';
    el.innerHTML = `
      <div class="meta">
        <div><strong>${escapeHtml(p.username)}</strong> â€¢ <span style="color:#777">${p.created_at}</span></div>
        <div>${p.likes_count} â™¥ &nbsp; ${p.comments_count} ðŸ’¬</div>
      </div>
      <div style="margin-top:8px">${nl2br(escapeHtml(p.content))}</div>
      <div class="controls">
        <button class="small-btn like-btn" data-id="${p.id}">${p.liked_by_me ? 'Unlike' : 'Like'}</button>
        <button class="small-btn comment-toggle" data-id="${p.id}">Comment</button>
        <button class="small-btn follow-btn" data-user="${p.user_id}">Follow</button>
      </div>
      <div class="comments" id="comments-${p.id}">
        ${p.comments.map(c => `<div><strong>${escapeHtml(c.username)}</strong> ${c.created_at}<div>${escapeHtml(c.content)}</div></div>`).join('')}
        <div class="comment-form" style="margin-top:8px;">
          <input placeholder="Write a comment..." data-post="${p.id}" class="comment-input" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;"/>
          <button class="small-btn comment-send" data-post="${p.id}">Send</button>
        </div>
      </div>
    `;
    container.appendChild(el);
  });

  // attach handlers
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      const resp = await fetch('/like.php', { method:'POST', body:new URLSearchParams({post_id:id}) });
      const j = await resp.json();
      if(j.success) fetchPosts();
    };
  });

  document.querySelectorAll('.comment-send').forEach(btn => {
    btn.onclick = async () => {
      const post_id = btn.dataset.post;
      const input = document.querySelector('.comment-input[data-post="'+post_id+'"]');
      const text = input.value.trim();
      if(!text) return;
      const resp = await fetch('/comment.php', { method:'POST', body:new URLSearchParams({post_id:post_id, content:text}) });
      const j = await resp.json();
      if(j.success){ input.value=''; fetchPosts(); }
    };
  });

  document.querySelectorAll('.follow-btn').forEach(btn => {
    btn.onclick = async () => {
      const user_id = btn.dataset.user;
      const resp = await fetch('/follow.php', { method:'POST', body:new URLSearchParams({user_id:user_id}) });
      const j = await resp.json();
      if(j.success) fetchPosts();
    };
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
}
function nl2br(s){ return s.replace(/\n/g, '<br/>'); }

document.getElementById('postBtn').addEventListener('click', async () => {
  const content = document.getElementById('postContent').value.trim();
  if(!content) return alert('Write something first');
  const resp = await fetch('/post.php', { method:'POST', body:new URLSearchParams({content:content}) });
  const j = await resp.json();
  if(j.success){ document.getElementById('postContent').value=''; fetchPosts(); }
  else alert('Error posting');
});

// initial fetch and periodic refresh every 5s
fetchPosts();
setInterval(fetchPosts, 5000);
</script>
</body>
</html>
